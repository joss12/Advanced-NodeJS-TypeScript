{"version":3,"file":"PlatformBuilder.js","sourceRoot":"","sources":["../../../src/platform-builder/builder/PlatformBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["import {classOf, constructorOf, Type} from \"@tsed/core\";\nimport {InjectorService} from \"@tsed/di\";\nimport {\n  GlobalAcceptMimesMiddleware,\n  IRoute,\n  LogIncomingRequestMiddleware,\n  Platform,\n  PlatformApplication,\n  PlatformContextMiddleware\n} from \"../../platform\";\nimport {GlobalErrorHandlerMiddleware, PlatformExceptionsMiddleware} from \"../../platform-exceptions\";\nimport {PlatformLogMiddleware} from \"../../platform/middlewares/PlatformLogMiddleware\";\nimport {\n  callHook,\n  createContainer,\n  createInjector,\n  createPlatformApplication,\n  getConfiguration,\n  importProviders,\n  listenHttpServer,\n  listenHttpsServer,\n  loadInjector,\n  printRoutes,\n  setLoggerLevel\n} from \"../utils\";\n\n/**\n * @platform\n */\nexport abstract class PlatformBuilder {\n  protected startedAt = new Date();\n  protected _rootModule: any;\n  protected _injector: InjectorService;\n\n  get injector(): InjectorService {\n    return this._injector;\n  }\n\n  get rootModule(): any {\n    return this._rootModule;\n  }\n\n  get app(): PlatformApplication {\n    return this.injector.get<PlatformApplication>(PlatformApplication)!;\n  }\n\n  get platform() {\n    return this.injector.get<Platform>(Platform)!;\n  }\n\n  /**\n   * Return the settings configured by the decorator @@Configuration@@.\n   *\n   * ```typescript\n   * @Configuration({\n   *    rootDir: Path.resolve(__dirname),\n   *    port: 8000,\n   *    httpsPort: 8080,\n   *    mount: {\n   *      \"/rest\": \"${rootDir}/controllers/**\\/*.js\"\n   *    }\n   * })\n   * export class Server {\n   *     $onInit(){\n   *         console.log(this.settings); // {rootDir, port, httpsPort,...}\n   *     }\n   * }\n   * ```\n   *\n   * @returns {ServerSettingsService}\n   */\n  get settings() {\n    return this.injector.settings;\n  }\n\n  get logger() {\n    return this.injector.logger;\n  }\n\n  static build<T extends PlatformBuilder>(platformBuildClass: Type<T>): T {\n    return new platformBuildClass();\n  }\n\n  /**\n   * Add classes to the components list\n   * @param classes\n   */\n  public addComponents(classes: any | any[]) {\n    this.settings.componentsScan = this.settings.componentsScan.concat(classes);\n\n    return this;\n  }\n\n  /**\n   * Add classes decorated by @@Controller@@ to components container.\n   *\n   * ### Example\n   *\n   * ```typescript\n   * @Controller('/ctrl')\n   * class MyController{\n   * }\n   *\n   * platform.addControllers('/rest', [MyController])\n   * ```\n   *\n   * ::: tip\n   * If the MyController class isn't decorated, the class will be ignored.\n   * :::\n   *\n   * @param {string} endpoint\n   * @param {any[]} controllers\n   */\n  public addControllers(endpoint: string, controllers: any | string | (any | string)[]) {\n    this.settings.mount[endpoint] = (this.settings.mount[endpoint] || []).concat(controllers);\n  }\n\n  public async runLifecycle() {\n    setLoggerLevel(this.injector);\n\n    const routes = await importProviders(this.injector);\n\n    await this.loadInjector();\n    await this.createContext();\n    await this.loadRoutes(routes);\n    await this.logRoutes();\n  }\n\n  async loadInjector() {\n    const {injector, logger} = this;\n    await this.callHook(\"$beforeInit\");\n    await this.callHook(\"$onInit\");\n\n    logger.info(\"Build providers\");\n\n    await loadInjector(injector, createContainer(constructorOf(this.rootModule)));\n\n    logger.debug(\"Settings and injector loaded\");\n    await this.callHook(\"$afterInit\");\n  }\n\n  async listen() {\n    const {logger, startedAt} = this;\n    await this.callHook(\"$beforeListen\");\n\n    await this.listenServers();\n\n    await this.callHook(\"$afterListen\");\n\n    await this.ready();\n    logger.info(`Started in ${new Date().getTime() - startedAt.getTime()} ms`);\n  }\n\n  public async ready() {\n    await this.callHook(\"$onReady\");\n    await this.injector.emit(\"$onServerReady\");\n  }\n\n  callHook(key: string, ...args: any[]) {\n    return callHook(this.injector, this.rootModule, key, ...args);\n  }\n\n  async loadStatics(): Promise<void> {\n    const {settings} = this;\n\n    if (settings.statics) {\n      Object.entries(settings.statics).forEach(([path, items]) => {\n        [].concat(items as any).forEach((options) => {\n          const opts =\n            typeof options === \"string\"\n              ? {\n                  root: options\n                }\n              : options;\n\n          this.platform.app.statics(path, opts);\n        });\n      });\n    }\n  }\n\n  protected async bootstrap(module: Type<any>, settings: Partial<TsED.Configuration> = {}) {\n    this.createInjector(module, settings);\n    this.createRootModule(module);\n\n    await this.runLifecycle();\n\n    return this;\n  }\n\n  protected async listenServers(): Promise<void> {\n    await Promise.all([listenHttpServer(this.injector), listenHttpsServer(this.injector)]);\n  }\n\n  protected logRoutes() {\n    const {logger, platform} = this;\n\n    if (!this.settings.logger.disableRoutesSummary) {\n      logger.info(\"Routes mounted :\");\n      logger.info(printRoutes(platform.getRoutes()));\n    }\n  }\n\n  protected async createContext() {\n    const middleware = new PlatformContextMiddleware(this.injector);\n\n    return this.app.use(middleware.use.bind(middleware));\n  }\n\n  protected async loadRoutes(routes: IRoute[]) {\n    const {logger, platform} = this;\n\n    // istanbul ignore next\n    if (this.settings.logger.level !== \"off\") {\n      if (classOf(this.injector.get(LogIncomingRequestMiddleware)) !== LogIncomingRequestMiddleware) {\n        this.app.use(LogIncomingRequestMiddleware);\n      } else {\n        this.app.use(PlatformLogMiddleware);\n      }\n    }\n\n    if (this.settings.acceptMimes?.length) {\n      this.app.use(GlobalAcceptMimesMiddleware);\n    }\n\n    logger.info(\"Load routes\");\n    await this.callHook(\"$beforeRoutesInit\"); // deprecated\n\n    platform.addRoutes(routes);\n\n    await this.callHook(\"$onRoutesInit\");\n\n    await this.loadStatics();\n\n    await this.callHook(\"$afterRoutesInit\");\n\n    this.app.use(PlatformExceptionsMiddleware);\n    this.app.use(GlobalErrorHandlerMiddleware);\n  }\n\n  protected createInjector(module: Type<any>, settings: any) {\n    this._injector = createInjector(getConfiguration(module, settings));\n    createPlatformApplication(this.injector);\n  }\n\n  protected createRootModule(module: Type<any>) {\n    this._rootModule = this.injector.invoke(module, undefined, {\n      // imports: this.settings.imports\n    });\n\n    this.injector.delete(constructorOf(this._rootModule));\n    this.injector.delete(classOf(this._rootModule));\n  }\n}\n"]}