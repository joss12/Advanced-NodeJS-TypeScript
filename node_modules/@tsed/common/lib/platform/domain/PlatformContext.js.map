{"version":3,"file":"PlatformContext.js","sourceRoot":"","sources":["../../../src/platform/domain/PlatformContext.ts"],"names":[],"mappings":";;;AAAA,iCAA0D;AAI1D,mDAAoE;AAWpE,MAAa,eAAgB,SAAQ,GAAa;IA2DhD,YAAY,EAAC,EAAE,EAAE,QAAQ,EAAE,MAAM,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE,GAAG,OAAO,EAAwB;QAChG,KAAK,EAAE,CAAC;QAlCV;;WAEG;QACM,cAAS,GAAS,IAAI,IAAI,EAAE,CAAC;QACtC;;WAEG;QACI,cAAS,GAAG,IAAI,oBAAe,EAAO,CAAC;QA4B5C,IAAI,CAAC,EAAE,GAAG,EAAE,CAAC;QAEb,QAAQ,IAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC,CAAC;QACvC,QAAQ,IAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC,CAAC;QACvC,OAAO,IAAI,CAAC,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC,CAAC;QACpC,QAAQ,IAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC,CAAC;QAEvC,IAAI,CAAC,MAAM,GAAG,IAAI,6BAAa,CAAC,MAAM,EAAE;YACtC,GAAG,OAAO;YACV,EAAE;YACF,SAAS,EAAE,IAAI,CAAC,SAAS;SAC1B,CAAC,CAAC;IACL,CAAC;IAED,IAAI,GAAG;QACL,OAAO,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,GAAG,CAAC;IACpC,CAAC;IAED,KAAK,CAAC,OAAO;QACX,MAAM,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,CAAC;QAC/B,IAAI,CAAC,MAAM,CAAC,OAAO,EAAE,CAAC;QACtB,IAAI,CAAC,QAAQ,CAAC,OAAO,EAAE,CAAC;QACxB,IAAI,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;QACvB,aAAa;QACb,OAAO,IAAI,CAAC,SAAS,CAAC;QACtB,aAAa;QACb,OAAO,IAAI,CAAC,MAAM,CAAC;QACnB,aAAa;QACb,OAAO,IAAI,CAAC,QAAQ,CAAC;QACrB,aAAa;QACb,OAAO,IAAI,CAAC,QAAQ,CAAC;QACrB,aAAa;QACb,OAAO,IAAI,CAAC,QAAQ,CAAC;QACrB,aAAa;QACb,OAAO,IAAI,CAAC,OAAO,CAAC;IACtB,CAAC;IAED,KAAK,CAAC,IAAI,CAAC,SAAiB,EAAE,GAAG,IAAW;QAC1C,OAAO,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,SAAS,EAAE,GAAG,IAAI,CAAC,CAAC;IACjE,CAAC;IAED;;OAEG;IACH,UAAU;QACR,OAAO,IAAI,CAAC,OAAO,CAAC,GAAU,CAAC;IACjC,CAAC;IAED;;OAEG;IACH,WAAW;QACT,OAAO,IAAI,CAAC,QAAQ,CAAC,GAAU,CAAC;IAClC,CAAC;CACF;AAnHD,0CAmHC;AAED;;GAEG;AACH,MAAa,cAAe,SAAQ,eAAe;CAAG;AAAtD,wCAAsD","sourcesContent":["import {InjectorService, LocalsContainer} from \"@tsed/di\";\nimport {EndpointMetadata} from \"../../mvc/models/EndpointMetadata\";\nimport {PlatformRequest} from \"../services/PlatformRequest\";\nimport {PlatformResponse} from \"../services/PlatformResponse\";\nimport {RequestLogger, RequestLoggerOptions} from \"./RequestLogger\";\n\nexport interface RequestContextOptions extends Omit<RequestLoggerOptions, \"dateStart\"> {\n  id: string;\n  logger: any;\n  injector?: InjectorService;\n  response?: PlatformResponse;\n  request?: PlatformRequest;\n  endpoint?: EndpointMetadata;\n}\n\nexport class PlatformContext extends Map<any, any> {\n  /**\n   * Request id generated by @@contextMiddleware@@.\n   *\n   * ::: tip\n   * By default Ts.ED generate uuid like that `uuidv4().replace(/-/gi, \"\"))`.\n   * Dash are removed to simplify tracking logs in Kibana\n   * :::\n   *\n   * ::: tip\n   * Request id can by customized by changing the server configuration.\n   *\n   * ```typescript\n   * @Configuration({\n   *   logger: {\n   *     reqIdBuilder: createUniqId // give your own id generator function\n   *   }\n   * })\n   * class Server {\n   *\n   * }\n   * ```\n   * :::\n   *\n   */\n  readonly id: string;\n  /**\n   * Date when request have been handled by the server. @@RequestLogger@@ use this date to log request duration.\n   */\n  readonly dateStart: Date = new Date();\n  /**\n   * The request container used by the Ts.ED DI. It contain all services annotated with `@Scope(ProviderScope.REQUEST)`\n   */\n  public container = new LocalsContainer<any>();\n  /**\n   * The current @@EndpointMetadata@@ resolved by Ts.ED during the request.\n   */\n  public endpoint: EndpointMetadata;\n  /**\n   * The data return by the previous endpoint if you use multiple handler on the same route. By default data is empty.\n   */\n  public data: any;\n  /**\n   * Logger attached to the context request.\n   */\n  public logger: RequestLogger;\n  /**\n   * The current @@PlatformResponse@@.\n   */\n  public response: PlatformResponse;\n  /**\n   * The current @@PlatformRequest@@.\n   */\n  public request: PlatformRequest;\n  /**\n   *\n   */\n  public injector: InjectorService;\n\n  constructor({id, injector, logger, response, request, endpoint, ...options}: RequestContextOptions) {\n    super();\n    this.id = id;\n\n    injector && (this.injector = injector);\n    response && (this.response = response);\n    request && (this.request = request);\n    endpoint && (this.endpoint = endpoint);\n\n    this.logger = new RequestLogger(logger, {\n      ...options,\n      id,\n      dateStart: this.dateStart\n    });\n  }\n\n  get env() {\n    return this.injector.settings.env;\n  }\n\n  async destroy() {\n    await this.container.destroy();\n    this.logger.destroy();\n    this.response.destroy();\n    this.request.destroy();\n    // @ts-ignore\n    delete this.container;\n    // @ts-ignore\n    delete this.logger;\n    // @ts-ignore\n    delete this.injector;\n    // @ts-ignore\n    delete this.endpoint;\n    // @ts-ignore\n    delete this.response;\n    // @ts-ignore\n    delete this.request;\n  }\n\n  async emit(eventName: string, ...args: any[]) {\n    return this.injector && this.injector.emit(eventName, ...args);\n  }\n\n  /**\n   * Return the original request instance.\n   */\n  getRequest<T = any>(): T {\n    return this.request.raw as any;\n  }\n\n  /**\n   * Return the original response instance.\n   */\n  getResponse<T = any>(): T {\n    return this.response.raw as any;\n  }\n}\n\n/**\n * @deprecated Use PlatformContext instead.\n */\nexport class RequestContext extends PlatformContext {}\n"]}